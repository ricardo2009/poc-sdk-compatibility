# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“¤ SDK RELEASE - EVENT EMITTER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Este workflow Ã© disparado quando o SDK Ã© publicado (release) ou manualmente.
# Ele emite um evento para o Orchestrator, que entÃ£o notifica todos os consumers.
#
# IMPORTANTE: Este workflow pode estar no repo do SDK ou neste repo central.
#             O importante Ã© que ele emita o evento correto.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸ“¤ SDK Release - Emit Event"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# TRIGGERS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

on:
  # Dispara quando uma release Ã© publicada
  release:
    types: [published]
  
  # Disparo manual para testes
  workflow_dispatch:
    inputs:
      version:
        description: 'SDK Version (ex: 1.0.0)'
        required: true
        default: '1.0.0'
      is_breaking:
        description: 'Contains breaking changes?'
        type: boolean
        default: false
      changelog:
        description: 'Changelog summary'
        required: false
        default: 'Manual trigger for testing'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ENVIRONMENT VARIABLES
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

env:
  # LÃª da variÃ¡vel de repositÃ³rio ou usa default
  GITHUB_ORG: ${{ vars.GITHUB_ORG || github.repository_owner }}
  ORCHESTRATOR_REPO: ${{ vars.ORCHESTRATOR_REPO || github.repository }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# JOBS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: EXTRACT RELEASE INFO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  extract-info:
    name: "ğŸ“¦ Extract Release Info"
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.info.outputs.version }}
      version_type: ${{ steps.info.outputs.version_type }}
      is_breaking: ${{ steps.info.outputs.is_breaking }}
      changelog: ${{ steps.info.outputs.changelog }}
      release_url: ${{ steps.info.outputs.release_url }}
    
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      
      - name: "ğŸ” Extract Info"
        id: info
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ EXTRACTING RELEASE INFORMATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Determina a fonte (release ou manual)
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            CHANGELOG="${{ github.event.release.body }}"
            RELEASE_URL="${{ github.event.release.html_url }}"
            
            # Detecta breaking changes no changelog
            if echo "$CHANGELOG" | grep -qi "breaking"; then
              IS_BREAKING="true"
            else
              IS_BREAKING="false"
            fi
          else
            # Manual dispatch
            VERSION="${{ github.event.inputs.version }}"
            CHANGELOG="${{ github.event.inputs.changelog }}"
            RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            IS_BREAKING="${{ github.event.inputs.is_breaking }}"
          fi
          
          # Remove 'v' prefix se existir
          VERSION="${VERSION#v}"
          
          # Determina tipo de versÃ£o
          if [[ "$VERSION" =~ ^[0-9]+\.0\.0$ ]]; then
            VERSION_TYPE="major"
          elif [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.0$ ]]; then
            VERSION_TYPE="minor"
          else
            VERSION_TYPE="patch"
          fi
          
          echo "ğŸ“‹ Release Info:"
          echo "   Version: $VERSION"
          echo "   Type: $VERSION_TYPE"
          echo "   Breaking: $IS_BREAKING"
          echo "   URL: $RELEASE_URL"
          
          # Set outputs
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "is_breaking=$IS_BREAKING" >> $GITHUB_OUTPUT
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: GENERATE COMPATIBILITY CONTRACT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  generate-contract:
    name: "ğŸ“œ Generate Contract"
    runs-on: ubuntu-latest
    needs: extract-info
    
    outputs:
      contract: ${{ steps.contract.outputs.contract }}
    
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      
      - name: "ğŸ“œ Generate Compatibility Contract"
        id: contract
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“œ GENERATING COMPATIBILITY CONTRACT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Gera contrato de compatibilidade
          CONTRACT=$(cat << 'CONTRACTEOF'
          {
            "sdk": {
              "name": "superapp-sdk",
              "version": "${{ needs.extract-info.outputs.version }}",
              "version_type": "${{ needs.extract-info.outputs.version_type }}",
              "is_breaking": ${{ needs.extract-info.outputs.is_breaking }}
            },
            "compatibility": {
              "min_node_version": "18.0.0",
              "min_npm_version": "9.0.0",
              "peer_dependencies": {
                "react": "^18.0.0",
                "react-native": "^0.73.0"
              }
            },
            "validation": {
              "required_tests": ["unit", "lint", "typecheck"],
              "timeout_minutes": 30
            },
            "generated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "generated_by": "${{ github.workflow }}"
          }
          CONTRACTEOF
          )
          
          echo "ğŸ“‹ Contract generated:"
          echo "$CONTRACT" | jq .
          
          # Escape para output
          CONTRACT_ESCAPED=$(echo "$CONTRACT" | jq -c .)
          echo "contract=$CONTRACT_ESCAPED" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: EMIT EVENT TO ORCHESTRATOR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  emit-event:
    name: "ğŸš€ Emit Event"
    runs-on: ubuntu-latest
    needs: [extract-info, generate-contract]
    
    steps:
      - name: "ğŸš€ Emit sdk.released Event"
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DISPATCH_TOKEN }}
          repository: ${{ env.ORCHESTRATOR_REPO }}
          event-type: sdk.released
          client-payload: |
            {
              "event_id": "${{ github.run_id }}-${{ github.run_attempt }}",
              "timestamp": "${{ github.event.head_commit.timestamp || github.event.release.created_at }}",
              "source": {
                "repository": "${{ github.repository }}",
                "workflow": "${{ github.workflow }}",
                "run_id": "${{ github.run_id }}",
                "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              },
              "sdk": {
                "version": "${{ needs.extract-info.outputs.version }}",
                "version_type": "${{ needs.extract-info.outputs.version_type }}",
                "is_breaking": ${{ needs.extract-info.outputs.is_breaking }},
                "release_url": "${{ needs.extract-info.outputs.release_url }}",
                "changelog": "${{ needs.extract-info.outputs.changelog }}"
              },
              "contract": ${{ needs.generate-contract.outputs.contract }}
            }
      
      - name: "ğŸ“‹ Summary"
        run: |
          echo "## ğŸ“¤ SDK Release Event Emitted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ needs.extract-info.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Type** | ${{ needs.extract-info.outputs.version_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Breaking** | ${{ needs.extract-info.outputs.is_breaking }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target** | \`${{ env.ORCHESTRATOR_REPO }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Event** | \`sdk.released\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Event dispatched successfully! The Orchestrator will now notify all consumers." >> $GITHUB_STEP_SUMMARY

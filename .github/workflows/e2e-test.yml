# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ§ª E2E TEST - FULL FLOW TEST
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Testa o fluxo completo: SDK â†’ Orchestrator â†’ Mini-apps
#
# Este workflow:
#   1. Simula uma release do SDK
#   2. Dispara o orchestrator
#   3. Valida os consumers reais (miniapp-pix-poc, miniapp-pagamentos-poc)
#   4. Coleta resultados
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸ§ª E2E Test - Full Flow"

on:
  workflow_dispatch:
    inputs:
      sdk_version:
        description: 'SDK version to simulate'
        required: true
        default: '1.0.0'
      change_type:
        description: 'Change type'
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'
      dry_run:
        description: 'Dry run (do not dispatch to consumers)'
        type: boolean
        default: false

env:
  GITHUB_ORG: ricardo2009

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: PREPARE TEST
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  prepare:
    name: "ğŸ“‹ Prepare Test"
    runs-on: ubuntu-latest
    
    outputs:
      event_id: ${{ steps.event.outputs.id }}
      consumers_json: ${{ steps.consumers.outputs.json }}
      consumers_count: ${{ steps.consumers.outputs.count }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: "ğŸ†” Generate Event ID"
        id: event
        run: |
          EVENT_ID="e2e-$(date +%Y%m%d%H%M%S)-$(openssl rand -hex 4)"
          echo "id=$EVENT_ID" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Event ID: $EVENT_ID"
      
      - name: "ğŸ“– Load Consumers"
        id: consumers
        run: |
          # Install yq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # Load enabled consumers
          CONSUMERS=$(yq -o=json '.consumers | map(select(.enabled == true))' .compatibility/consumers.yml)
          COUNT=$(echo "$CONSUMERS" | jq 'length')
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ LOADED CONSUMERS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "$CONSUMERS" | jq -r '.[] | "  â€¢ \(.name) [\(.priority)] â†’ \(.repository)"'
          echo ""
          echo "Total: $COUNT consumers"
          
          # Output
          echo "json=$(echo "$CONSUMERS" | jq -c .)" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
      
      - name: "ğŸ“Š Test Summary - Setup"
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## ğŸ§ª E2E Test - Setup
          
          | Parameter | Value |
          |-----------|-------|
          | Event ID | \`${{ steps.event.outputs.id }}\` |
          | SDK Version | ${{ github.event.inputs.sdk_version }} |
          | Change Type | ${{ github.event.inputs.change_type }} |
          | Dry Run | ${{ github.event.inputs.dry_run }} |
          | Consumers | ${{ steps.consumers.outputs.count }} |
          
          ### Consumers to Test
          $(echo '${{ steps.consumers.outputs.json }}' | jq -r '.[] | "- **\(.name)** (\(.priority)) â†’ `\(.repository)`"')
          EOF

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: CHECK API RATE LIMIT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  rate-check:
    name: "ğŸ” Check Rate Limit"
    runs-on: ubuntu-latest
    needs: prepare
    
    outputs:
      remaining: ${{ steps.check.outputs.remaining }}
      can_proceed: ${{ steps.check.outputs.can_proceed }}
    
    steps:
      - name: "ğŸ” Check GitHub API Rate Limit"
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RATE=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/rate_limit)
          
          REMAINING=$(echo "$RATE" | jq '.rate.remaining')
          LIMIT=$(echo "$RATE" | jq '.rate.limit')
          RESET=$(echo "$RATE" | jq '.rate.reset')
          RESET_TIME=$(date -d @$RESET "+%H:%M:%S")
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” RATE LIMIT STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Remaining: $REMAINING / $LIMIT"
          echo "Resets at: $RESET_TIME"
          
          # Need at least 50 calls for E2E test
          if [ $REMAINING -lt 50 ]; then
            CAN_PROCEED="false"
            echo ""
            echo "âŒ Insufficient rate limit for E2E test"
          else
            CAN_PROCEED="true"
            echo ""
            echo "âœ… Rate limit OK"
          fi
          
          echo "remaining=$REMAINING" >> $GITHUB_OUTPUT
          echo "can_proceed=$CAN_PROCEED" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: DISPATCH TO CONSUMERS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  dispatch:
    name: "ğŸš€ Dispatch - ${{ matrix.consumer.name }}"
    runs-on: ubuntu-latest
    needs: [prepare, rate-check]
    if: needs.rate-check.outputs.can_proceed == 'true'
    
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        consumer: ${{ fromJSON(needs.prepare.outputs.consumers_json) }}
    
    steps:
      - name: "ğŸš€ Dispatch to ${{ matrix.consumer.name }}"
        id: dispatch
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          CONSUMER_NAME="${{ matrix.consumer.name }}"
          CONSUMER_REPO="${{ matrix.consumer.repository }}"
          EVENT_TYPE="${{ matrix.consumer.workflow.event_type }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ DISPATCHING TO: $CONSUMER_NAME"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Repository: $CONSUMER_REPO"
          echo "Event Type: $EVENT_TYPE"
          echo ""
          
          if [ "$DRY_RUN" == "true" ]; then
            echo "ğŸƒ DRY RUN - Skipping actual dispatch"
            echo "dispatched=false" >> $GITHUB_OUTPUT
            echo "status=skipped" >> $GITHUB_OUTPUT
          else
            # Check if PAT_TOKEN is set
            if [ -z "$GH_TOKEN" ]; then
              echo "âŒ PAT_TOKEN secret not set!"
              echo "   Please add a Personal Access Token with repo scope"
              echo "dispatched=false" >> $GITHUB_OUTPUT
              echo "status=no_token" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # Build payload
            PAYLOAD=$(cat << PAYLOAD_END
          {
            "event_type": "$EVENT_TYPE",
            "client_payload": {
              "event": {
                "id": "${{ needs.prepare.outputs.event_id }}",
                "type": "e2e-test",
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
              },
              "sdk": {
                "version": "${{ github.event.inputs.sdk_version }}",
                "change_type": "${{ github.event.inputs.change_type }}",
                "is_breaking": false,
                "repository": "${{ env.GITHUB_ORG }}/superapp-sdk-poc"
              },
              "orchestrator": {
                "repo": "${{ github.repository }}",
                "run_id": "${{ github.run_id }}"
              },
              "rules": {
                "auto_merge": ${{ matrix.consumer.config.auto_merge_patch }},
                "require_tests": ${{ matrix.consumer.config.require_tests }}
              }
            }
          }
          PAYLOAD_END
          )
            
            echo "ğŸ“¤ Sending payload..."
            echo "$PAYLOAD" | jq .
            
            # Dispatch event
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$CONSUMER_REPO/dispatches" \
              -d "$PAYLOAD")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            
            if [ "$HTTP_CODE" == "204" ] || [ "$HTTP_CODE" == "200" ]; then
              echo ""
              echo "âœ… Successfully dispatched to $CONSUMER_NAME"
              echo "dispatched=true" >> $GITHUB_OUTPUT
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo ""
              echo "âŒ Failed to dispatch (HTTP $HTTP_CODE)"
              echo "$BODY"
              echo "dispatched=false" >> $GITHUB_OUTPUT
              echo "status=failed" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: "ğŸ“Š Dispatch Result"
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ### ğŸ“¤ Dispatch: ${{ matrix.consumer.name }}
          
          | Field | Value |
          |-------|-------|
          | Repository | \`${{ matrix.consumer.repository }}\` |
          | Priority | ${{ matrix.consumer.priority }} |
          | Status | ${{ steps.dispatch.outputs.status || 'unknown' }} |
          EOF

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  summary:
    name: "ğŸ“Š Test Summary"
    runs-on: ubuntu-latest
    needs: [prepare, rate-check, dispatch]
    if: always()
    
    steps:
      - name: "ğŸ“Š Generate Final Summary"
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          
          ---
          
          ## ğŸ§ª E2E Test Complete
          
          ### Flow Executed
          
          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                        E2E TEST FLOW                            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ğŸ“‹ PREPARE                                                      â”‚
          â”‚  â€¢ Generated Event ID                                           â”‚
          â”‚  â€¢ Loaded consumers from registry                               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ğŸ” RATE CHECK                                                   â”‚
          â”‚  â€¢ Verified API rate limit                                      â”‚
          â”‚  â€¢ Confirmed capacity for dispatch                              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ğŸš€ DISPATCH                                                     â”‚
          â”‚  â€¢ Sent sdk.validate events to consumers                        â”‚
          â”‚  â€¢ Parallel dispatch (max 2)                                    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  âœ… CONSUMERS EXECUTING                                          â”‚
          â”‚  â€¢ miniapp-pix-poc â†’ consumer-validate.yml                      â”‚
          â”‚  â€¢ miniapp-pagamentos-poc â†’ consumer-validate.yml               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ```
          
          ### Next Steps
          
          1. Check consumer repositories for workflow execution:
             - [miniapp-pix-poc Actions](https://github.com/ricardo2009/miniapp-pix-poc/actions)
             - [miniapp-pagamentos-poc Actions](https://github.com/ricardo2009/miniapp-pagamentos-poc/actions)
          
          2. Verify the `consumer-validate.yml` workflow was triggered
          
          3. Check for any PRs created by the validation process
          
          EOF
